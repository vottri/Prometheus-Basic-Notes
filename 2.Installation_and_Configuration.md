# Installation and Configuration

Contents

===========================================

[1. Basic Configuration](#1)

[2. Installing Prometheus](#2)

[3. Installing Node Exporter](#3)

[4. Configuring Prometheus to monitor Targets](#4)

[5. Installing Grafana](#5)

[6. Configuring Grafana](#6)

[7. Installing Alert Manager](#7)

[8. Configuring Alert Manager](#8)

===========================================

## 1. Basic Configuration <a name="1"></a>

Update the system.
```sh
sudo apt-get update
```
Install some required packages:
sudo apt-get install -y apt-transport-https software-properties-common gnupg2


## 2. Installing Prometheus <a name="2"></a>

Create a prometheus user (without login permission and without home directory).
```sh
sudo useradd -M -r -s /bin/false prometheus
```
![prom_user](https://raw.githubusercontent.com/vottri/Prometheus-Grafana-Basic-Notes/main/images/prom_user.png)

Create configuration and data directories for Prometheus.
```sh
sudo mkdir /etc/prometheus /var/lib/prometheus
```

Download the Prometheus binary file.
```sh
wget https://github.com/prometheus/prometheus/releases/download/v2.37.5/prometheus-2.37.5.linux-amd64.tar.gz
```

Extract the downloaded file.
```sh
tar xvfz prometheus-2.37.5.linux-amd64.tar.gz
```
![prom_file](https://raw.githubusercontent.com/vottri/Prometheus-Grafana-Basic-Notes/main/images/prom_file.png)
Move the files from the extracted folder to the appropriate locations and set ownership.
```sh
sudo cp prometheus-2.37.5.linux-amd64/{prometheus,promtool} /usr/local/bin
sudo chown prometheus:prometheus /usr/local/bin/{prometheus,promtool}

sudo cp -r prometheus-2.37.5.linux-amd64/{consoles,console_libraries} /etc/prometheus/
sudo cp prometheus-2.37.5.linux-amd64/prometheus.yml /etc/prometheus/prometheus.yml

sudo chown -R prometheus:prometheus /etc/prometheus/
sudo chown prometheus:prometheus /var/lib/prometheus/
```
Create a systemd unit file for Prometheus to run in the background.
```sh
sudo nano /etc/systemd/system/prometheus.service
```
```sh
[Unit]
Description=Prometheus Time Series Collection and Processing Server
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
--config.file /etc/prometheus/prometheus.yml \
--storage.tsdb.path /var/lib/prometheus/ \
--web.console.templates=/etc/prometheus/consoles \
--web.console.libraries=/etc/prometheus/console_libraries
--web.listen-address=0.0.0.0:9090

[Install]
WantedBy=multi-user.target
```

Start and enable the Prometheus service.
```sh
sudo systemctl daemon-reload
sudo systemctl start prometheus
sudo systemctl enable prometheus
```

Verify that the service is running.
![prom_status](https://raw.githubusercontent.com/vottri/Prometheus-Grafana-Basic-Notes/main/images/prom_status.png)

Visit port 9090 of prometheus server in a browser and it will show the following web page.


## 3. Installing Node Exporter <a name="3"></a>

Create a node_exporter user (without login permission and without home directory).
```sh
sudo useradd -M -r -s /bin/false node_exporter
```

Download and extract the node exporter binary file.
```sh
wget https://github.com/prometheus/node_exporter/releases/download/v1.5.0/node_exporter-1.5.0.linux-amd64.tar.gz
tar xvfz node_exporter-1.5.0.linux-amd64.tar.gz
```
Copy the node_exporter executable file to /usr/local/bin directory and set ownership.
```sh
sudo cp node_exporter-1.5.0.linux-amd64/node_exporter /usr/local/bin/
sudo chown node_exporter:node_exporter /usr/local/bin/node_exporter
```

Create a service file for node exporter to run it is as a daemon:
```sh
sudo nano /etc/systemd/system/node_exporter.service
```
```sh
[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
```

Start and enable the node_exporter service.
```sh
sudo systemctl daemon-reload
sudo systemctl start node_exporter
sudo systemctl enable node_exporter	
```

Verify that the service is running.
sudo systemctl status node_exporter

## 4. Configuring Prometheus to monitor Targets <a name="4"></a>

Head to the prometheus.yml file.
```sh
sudo nano /etc/prometheus/prometheus.yml
```
Modify the file with the following configuration.
```sh
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: "prometheus"
    scrape_interval: 10s
    static_configs:
     - targets: ["localhost:9090"]
  - job_name: "node_exporter"
    scrape_interval: 10s
    static_configs:
     - targets: ["localhost:9100","10.0.0.5:9100"]
```

Restart the prometheus service.
```sh
sudo systemctl restart prometheus
```

Visit port 9090 of prometheus server in a browser. Click "Status" on the top menu and choose "Targets".

It will list all the targets defined in the prometheus.yml config file there.

## 5. Installing Grafana <a name="5"></a>

Add the GPG key for the Grafana OSS repository, then add the repository.
```sh
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
```

Update the apt-repositories.
```sh
sudo apt-get update
```

Install the Grafana package.
```sh
sudo apt-get -y install grafana
```

Start and enable grafana-server service.
```sh
sudo systemctl daemon-reload
sudo systemctl start grafana-server
sudo systemctl enable grafana-server
```

Verify that the service is running.
![gra_status](https://raw.githubusercontent.com/vottri/Prometheus-Grafana-Basic-Notes/main/images/gra_status.png)

## 6. Configuring Grafana <a name="6"></a>

### Adding Data Source

Open your web browser and go to http://localhost:3000. The default HTTP port that Grafana listens to is 3000, unless you have configured a different port

Log into the Grafana Dashboard using the default username and password (admin). Change password for your convenience.

Navigate to the settings icon on the left side menu and then click on "Data Sources".

Select the "Data Sources" tab and click on "Add data source".

It will open "Add data source" page. Select the "Prometheus" as data source.

Enter the name and the url of the Prometheus data source.

Click on the "Save & Test" button at the end of the page. You should see a banner that says "Data source is working".

### Adding Dashboard

Grafana allows you to import pre-built dashboards, many of which are built with Prometheus data in mind. You can find those at https://grafana.com/grafana/dashboards. All you need is the ID.
  
In the Grafana Dashboard:
  
On the left menu, hover over the "Add" symbol and click on "import".

Enter the Grafana dashboard id and click on "load".

After loading the dashboard, it will ask for the dashboard name, which folder to save the dashboard and the Prometheus data source. You can also change "uid" if you want. Click "Import" after providing the required details.


## 7. Monitoring system resources using Grafana <a name="7"></a>

After importing the dashboard, it will display a monitoring dashboard. Click on the time range selector on the top right corner of the dashboard and select a time range.

The Dashboard will display all the system data Prometheus has collected for the selected time range.

Scroll down the dashboard and you can view a variety of different metrics there. 


## 8. Installing Alert Manager <a name="8"></a>

Create an alertmanager user (without login permissions and without home directory).
```sh
sudo useradd -M -r -s /bin/false alertmanager
```

Create a data directory for alertmanager.
```sh
sudo mkdir /var/lib/alertmanager
sudo chown alertmanager:alertmanager /var/lib/alertmanager
```

Download and extract the Alertmanager binary file.
```sh
wget https://github.com/prometheus/alertmanager/releases/download/v0.24.0/alertmanager-0.24.0.linux-amd64.tar.gz
tar xvfz alertmanager-0.24.0.linux-amd64.tar.gz
```

Move the extracted files into the appropriate locations, and set ownership.
```sh
sudo cp alertmanager-0.24.0.linux-amd64/{alertmanager,amtool} /usr/local/bin/
sudo chown alertmanager:alertmanager /usr/local/bin/{alertmanager,amtool}
```

Create configuration file for alertmanager and amtool.
```sh
sudo mkdir /etc/alertmanager/
sudo cp alertmanager-0.24.0.linux-amd64/alertmanager.yml /etc/alertmanager/alertmanager.yml

sudo mkdir /etc/amtool
sudo nano /etc/amtool/config.yml
```
Enter the following content in the amtool config file.
```sh
alertmanager.url: http://localhost:9093
```

Set ownership.
```sh
sudo chown -R alertmanager:alertmanager /etc/alertmanager/
sudo chown -R alertmanager:alertmanager /etc/amtool
```

Create a systemd unit file for Alertmanager.
```sh
sudo nano /etc/systemd/system/alertmanager.service
```
```sh
[Unit]
Description=Prometheus Alertmanager
Wants=network-online.target
After=network-online.target

[Service]
User=alertmanager
Group=alertmanager
Type=simple
ExecStart=/usr/local/bin/alertmanager \
--config.file /etc/alertmanager/alertmanager.yml \
--storage.path /var/lib/alertmanager/

[Install]
WantedBy=multi-user.target
```

Start and enable the alertmanager service.
```sh
sudo systemctl daemon-reload
sudo systemctl start alertmanager
sudo systemctl enable alertmanager
```

Verify that the service is running.
sudo systemctl status alertmanager

Verify that amtool is able to connect to Alertmanager and retrieve the current configuration.
amtool config show

Visit port 9093 of the server in a browser (e.g. http://mysite.com:9093) 
  

## 9. Configuring Prometheus Alert Manager <a name="9"></a>

### Configuring Prometheus to Connect to Alertmanager

Edit the Prometheus config.
```sh
sudo nano /etc/prometheus/prometheus.yml
```
Append the following configuration.
```sh
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
  - static_configs:
     - targets: ["localhost:9093"]

rule_files:
  - "rules.yml"     
     
scrape_configs:
  - job_name: "prometheus"
    scrape_interval: 10s
    static_configs:
     - targets: ["localhost:9090"]
  - job_name: "node_exporter"
    scrape_interval: 10s
    static_configs:
     - targets: ["localhost:9100","10.0.0.5:9100"]
```

### Adding Alert Manager Rules

Create a file named ‘rules.yml’ in the /etc/prometheus directory.
```sh
sudo nano /etc/prometheus/rules.yml
```
Add the alert rules.
```sh
groups:
- name: alert.rules
  rules:
  - alert: HostOutOfMemory
    expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 < 25
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Host out of memory (instance {{ $labels.instance }})"
      description: "Node memory is filling up (< 25% left)\n VALUE = {{ $value }}\n LABELS: {{ $labels }}"
  - alert: HostHighCpuLoad
    expr: (sum by (instance) (irate(node_cpu_seconds_total{job="System Resources",mode="idle"}[5m]))) > 80
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Host high CPU load (instance {{ $labels.instance }})"
      description: "CPU load is > 80%\n VALUE = {{ $value }}\n LABELS: {{ $labels }}"
```
Verify that Prometheus is able to reach the Alertmanager. Access Prometheus in a web browser at http://<Prometheus
server public IP>:9090.
Click Status > Runtime & Build Information.
Verify that your Alertmanager instance appears under the Alertmanagers section
  
  
Visit port 9090 of prometheus server in a browser (e.g. http://mysite.com:9090 and click on the ‘Alert’ button and it will show all the alerts configured in the ‘rules.yml’ file.
  

Set ownership for "rule.yml" file.
```sh
sudo chown prometheus:prometheus /etc/prometheus/rules.yml
```

Restart the Prometheus service to apply the changes.
```sh
sudo systemctl restart prometheus
```

### Configuring Email Notification

Open the alertmanager.yml file 
```sh
sudo nano /etc/alertmanager/alertmanager.yml
```
Provide email configuration
```sh
global:
  resolve_timeout: 1m
route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'email_notification'
receivers:
- name: 'email_notification'
  email_configs:
  - to : sysadmin@gmail.com
    from: sysadmin@gmail.com
    smarthost: smtp.gmail.com:587
    auth_username: sysadmin@gmail.com
    auth_identity: sysadmin@gmail.com
    auth_password: app_password
    send_resolved: true
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']
```

Restart the alert manager and prometheus services.
```sh
sudo systemctl restart prometheus
sudo systemctl restart alertmanager
```

  
Now whenever system resources cross a specific threshold defined in rules.yml file, the status of alerts will change from ‘inactive’ to ‘pending’.
  
And after some time, the status will be in ‘Firing’ state and an email notification will be sent.
